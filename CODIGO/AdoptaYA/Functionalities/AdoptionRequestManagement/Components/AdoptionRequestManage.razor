@using AdoptaYA.Functionalities.AdoptionRequestManagement.DTO

<Loader Loading="loading" />

<RadzenStack Gap="1rem" class="rz-p-0 rz-p-lg-4">
    <RadzenRow Gap="2rem">
        <!-- Columna Izquierda: Información de Adopción, Solicitante, Mascota y Fotos -->
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenStack Gap="1rem">
                <RadzenFieldset Text="Información de la Solicitud" class="fw-bold">
                    <RadzenStack Gap="1rem" class="fw-normal">
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="ID de Solicitud" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Adoption?.Id</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Estado" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                @if (!isEditingStatus)
                                {
                                    <div class="d-flex align-items-center gap-2">
                                        <RadzenBadge BadgeStyle="@(data?.Adoption?.Status == "Cancelada" ? BadgeStyle.Danger : BadgeStyle.Success)"
                                                     Text="@data?.Adoption?.Status" />
                                        <RadzenButton Icon="edit"
                                                      ButtonStyle="ButtonStyle.Light"
                                                      Size="ButtonSize.Small"
                                                      Click="@StartEditStatus"
                                                      Visible="!applicationCompleted" />
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex align-items-center gap-2">
                                        <RadzenDropDown @bind-Value="@selectedStatus"
                                                        Data="@statusList"
                                                        Style="width: 200px;" />
                                        <RadzenButton Icon="check"
                                                      ButtonStyle="ButtonStyle.Success"
                                                      Size="ButtonSize.Small"
                                                      Click="@SaveStatus" />
                                        <RadzenButton Icon="close"
                                                      ButtonStyle="ButtonStyle.Danger"
                                                      Size="ButtonSize.Small"
                                                      Click="@CancelEditStatus" />
                                    </div>
                                }
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Fecha de Registro" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@(data?.Adoption?.Date.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Fecha de Adopción" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@(data?.Adoption?.AdoptionDate.ToString("dd/MM/yyyy") ?? "Pendiente")</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="No. Documento" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@(data?.Adoption?.DocumentNumber?.ToString() ?? "N/A")</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        @if (!string.IsNullOrEmpty(data?.Adoption?.Attachment))
                        {
                            <RadzenRow AlignItems="AlignItems.Center">
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenLabel Text="Adjunto" class="fw-bold" />
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="8">
                                    <RadzenButton Text="Ver Documento" Icon="attach_file" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small" />
                                </RadzenColumn>
                            </RadzenRow>
                        }
                    </RadzenStack>
                </RadzenFieldset>

                <RadzenFieldset Text="Información del Solicitante" class="fw-bold">
                    <RadzenStack Gap="1rem" class="fw-normal">
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Nombre Completo" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Applicant?.Name @data?.Applicant?.LastName</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Fecha de Nacimiento" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@(data?.Applicant?.BirthDate?.ToString("dd/MM/yyyy") ?? "N/A")</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Correo" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Applicant?.Email</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Celular" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Applicant?.CellPhone</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        @if (!string.IsNullOrEmpty(data?.Applicant?.HomePhone))
                        {
                            <RadzenRow AlignItems="AlignItems.Center">
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenLabel Text="Teléfono Casa" class="fw-bold" />
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="8">
                                    <RadzenText class="rz-m-0">@data?.Applicant?.HomePhone</RadzenText>
                                </RadzenColumn>
                            </RadzenRow>
                        }
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Dirección" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0" Style="white-space: pre-wrap;">@data?.Applicant?.Address</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Ingresos" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">Q. @(data?.Applicant?.Income.ToString("N2") ?? "N/A")</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        @if (!string.IsNullOrEmpty(data?.Applicant?.MaritalStatus))
                        {
                            <RadzenRow AlignItems="AlignItems.Center">
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenLabel Text="Estado Civil" class="fw-bold" />
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="8">
                                    <RadzenText class="rz-m-0">@data?.Applicant?.MaritalStatus</RadzenText>
                                </RadzenColumn>
                            </RadzenRow>
                        }
                        @if (!string.IsNullOrEmpty(data?.Applicant?.Occupation))
                        {
                            <RadzenRow AlignItems="AlignItems.Center">
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenLabel Text="Ocupación" class="fw-bold" />
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="8">
                                    <RadzenText class="rz-m-0">@data?.Applicant?.Occupation</RadzenText>
                                </RadzenColumn>
                            </RadzenRow>
                        }
                    </RadzenStack>
                </RadzenFieldset>

                <RadzenFieldset Text="Fotografías" class="fw-bold">
                    <RadzenStack Gap="1rem">
                        <RadzenCarousel Auto="true" AllowNavigation="@true"
                                        Style="height: 400px; max-width: 400px;" class="rz-mx-auto"
                                        ButtonStyle="ButtonStyle.Light" ButtonSize="ButtonSize.Medium" ButtonShade="Shade.Default" ButtonVariant="Variant.Flat">
                            <Items>
                                @if (!string.IsNullOrEmpty(data?.Pet?.MainPhoto))
                                {
                                    <RadzenCarouselItem>
                                        <RadzenImage Path="@data?.Pet?.MainPhoto" Style="width: 100%; height: 100%; object-fit: contain;" />
                                    </RadzenCarouselItem>
                                }
                                @if (!string.IsNullOrEmpty(data?.Pet?.SecondaryPhoto))
                                {
                                    <RadzenCarouselItem>
                                        <RadzenImage Path="@data?.Pet?.SecondaryPhoto" Style="width: 100%; height: 100%; object-fit: contain;" />
                                    </RadzenCarouselItem>
                                }
                                @if (!string.IsNullOrEmpty(data?.Pet?.AdditionalPhoto))
                                {
                                    <RadzenCarouselItem>
                                        <RadzenImage Path="@data?.Pet?.AdditionalPhoto" Style="width: 100%; height: 100%; object-fit: contain;" />
                                    </RadzenCarouselItem>
                                }
                            </Items>
                        </RadzenCarousel>
                    </RadzenStack>
                </RadzenFieldset>
            </RadzenStack>
        </RadzenColumn>

        <!-- Columna Derecha: Vacunas y Enfermedades -->
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenStack Gap="1rem">
                <RadzenFieldset Text="Información de la Mascota" class="fw-bold">
                    <RadzenStack Gap="1rem" class="fw-normal">
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Nombre" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0" TextStyle="TextStyle.H6">@data?.Pet?.PetName</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Especie" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Pet?.Animal?.Species</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Raza" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Pet?.Animal?.Breed</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Tamaño" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Pet?.Size</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Peso (kg)" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Pet?.Weight</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Color" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0">@data?.Pet?.Color</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="Comportamiento" class="fw-bold" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenText class="rz-m-0" Style="white-space: pre-wrap;">@data?.Pet?.Behavior</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenFieldset>

                <RadzenFieldset Text="Vacunas" class="fw-bold">
                    <RadzenDataGrid TItem="VacunaResponse" Data="@data?.Pet?.Vaccines" EmptyText="No hay vacunas registradas" ShowPagingSummary="false" class="fw-normal" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="VacunaResponse" Property="Description" Title="Descripción" />
                            <RadzenDataGridColumn TItem="VacunaResponse" Title="Estado">
                                <Template Context="vaccine">
                                    @(vaccine.Applied == 1 ? "Aplicada" : "No aplicada")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="VacunaResponse" Title="Fecha aplicada">
                                <Template Context="vaccine">
                                    @(vaccine.ApplicationDate.ToString("dd/MM/yyyy") ?? "Sin fecha")
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenFieldset>

                <RadzenFieldset Text="Enfermedades" class="fw-bold">
                    <RadzenDataGrid TItem="EnfermedadResponse" Data="@data?.Pet?.Diseases" ExpandMode="DataGridExpandMode.Single"
                                    @ref="diseasesGrid" RowRender="@RowRenderDiseases" class="fw-normal" EmptyText="No hay enfermedades registradas" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="EnfermedadResponse" Property="Description" Title="Descripción" />
                            <RadzenDataGridColumn TItem="EnfermedadResponse" Property="Treatment" Title="Tratamiento">
                                <Template Context="disease">
                                    <RadzenText class="rz-m-0" Style="white-space: pre-wrap;">@disease.Treatment</RadzenText>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>

                        <Template Context="disease">
                            <RadzenCard Variant="Variant.Outlined" Style="margin: 1rem;">
                                <RadzenText TextStyle="TextStyle.Subtitle2" class="fw-bold rz-mb-2">
                                    Medicinas para @disease.Description
                                </RadzenText>

                                <RadzenDataGrid TItem="MedicinaResponse" Data="@disease.Medicines" AllowPaging="false" AllowSorting="false" EmptyText="No hay tratamientos registrados">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="MedicinaResponse" Property="Name" Title="Nombre" />
                                        <RadzenDataGridColumn TItem="MedicinaResponse" Property="Description" Title="Descripción" />
                                        <RadzenDataGridColumn TItem="MedicinaResponse" Property="Indications" Title="Indicaciones" />
                                    </Columns>
                                </RadzenDataGrid>
                            </RadzenCard>
                        </Template>
                    </RadzenDataGrid>
                </RadzenFieldset>

                <RadzenFieldset Text="Seguimientos" class="fw-bold">
                    <RadzenDataGrid TItem="SeguimientoResponse" Data="@data?.FollowUp" EmptyText="No hay seguimientos registrados" ShowPagingSummary="false" class="fw-normal" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="SeguimientoResponse" Title="Fecha de Seguimiento">
                                <Template Context="seguimiento">
                                    @seguimiento.FollowUpDate?.ToString("dd/MM/yyyy")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="SeguimientoResponse" Property="Observations" Title="Observaciones">
                                <Template Context="seguimiento">
                                    <RadzenText Style="white-space: pre-wrap; font-size: 0.8rem;" class="rz-m-0 lh-1" >@seguimiento.Observations</RadzenText>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                    <RadzenButton Icon="add" Text="Agregar seguimiento" Click="@(() => OpenAddAdoptionFollowUp(data!.Adoption!.Id))"
                                  ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" class="mt-3 float-end" Visible="!applicationCompleted" />
                </RadzenFieldset>

                <RadzenFieldset Text="Retorno" class="fw-bold">
                    <RadzenDataGrid TItem="RetornoResponse" Data="@data?.ReturnPet" EmptyText="No hay retorno registrado" ShowPagingSummary="false" class="fw-normal" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="RetornoResponse" Title="Fecha de Retorno">
                                <Template Context="retorno">
                                    @retorno.ReturnDate?.ToString("dd/MM/yyyy")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="RetornoResponse" Property="Observations" Title="Observaciones">
                                <Template Context="retorno">
                                    <RadzenText Style="white-space: pre-wrap; font-size: 0.8rem;" class="rz-m-0 lh-1">@retorno.Observations</RadzenText>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                    <RadzenButton Icon="add" Text="Agregar retorno" Click="@(() => OpenAddAdoptionReturn(data!.Adoption!.Id))"
                                  ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" class="mt-3 float-end" Visible="@( (data?.ReturnPet == null || !data.ReturnPet.Any()) && !applicationCompleted )" />
                </RadzenFieldset>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenFieldset Text="Referencias personales del solicitante" class="fw-bold">
            <RadzenDataGrid TItem="PersonalReferenceResponse" Data="@data?.PersonalReferences" EmptyText="No hay referencias registradas" 
                            ShowPagingSummary="false" class="fw-normal" AllowPaging="false">
                <Columns>
                    <RadzenDataGridColumn TItem="PersonalReferenceResponse" Property="Id" Title="#" />
                    <RadzenDataGridColumn TItem="PersonalReferenceResponse" Property="Name" Title="Nombre" />
                    <RadzenDataGridColumn TItem="PersonalReferenceResponse" Property="CellPhone" Title="Teléfono" />
                    <RadzenDataGridColumn TItem="PersonalReferenceResponse" Property="Relationship" Title="Vinculo" />
                </Columns>
            </RadzenDataGrid>
        </RadzenFieldset>
    </RadzenRow>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem">
        <RadzenButton ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Large" Icon="arrow_back" Text="Cerrar" Click="@Close" />
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Size="ButtonSize.Large" Icon="picture_as_pdf" Text="Imprimir solicitud" Click="@DownloadAdoptionRequestPdf" />
    </RadzenStack>
</RadzenStack>